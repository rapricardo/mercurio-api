# üè¢ Tenant Management API

**Status**: ‚úÖ Production Ready  
**Version**: 1.0.0  
**Sprint**: Multi-tenant Architecture  
**Completed**: 2025-08-27

## üéØ Overview

A Tenant Management API fornece controle completo sobre o sistema multi-tenant da aplica√ß√£o Mercurio. Permite cria√ß√£o, gerenciamento e monitoramento de tenants com isolamento completo de dados, autentica√ß√£o segura e administra√ß√£o granular de permiss√µes.

### üöÄ Principais Benef√≠cios

- **üè¢ Multi-tenancy Segura**: Isolamento completo de dados entre tenants
- **üîê Controle de Acesso**: Permiss√µes granulares por tenant e usu√°rio
- **üìä Administra√ß√£o Completa**: CRUD completo com filtros avan√ßados
- **üìà Analytics Integrado**: Estat√≠sticas e m√©tricas por tenant
- **üîç Audit Trail**: Rastreamento completo de altera√ß√µes

---

## üìã Endpoints Dispon√≠veis

### 1. üìã List All Tenants
**GET** `/v1/tenants`

Lista todos os tenants com filtros e pagina√ß√£o avan√ßada.

**Par√¢metros de Query**:
- `page`: N√∫mero da p√°gina (padr√£o: 1)
- `pageSize`: Itens por p√°gina (padr√£o: 20, m√°x: 100)  
- `search`: Busca por nome do tenant
- `status`: Filtrar por status (`active` | `inactive` | `suspended`)
- `plan`: Filtrar por plano de assinatura
- `sortBy`: Campo de ordena√ß√£o (`name` | `createdAt` | `status`)
- `sortOrder`: Ordem (`asc` | `desc`, padr√£o: `desc`)
- `includeStats`: Incluir estat√≠sticas (padr√£o: `false`)

**Response**:
```json
{
  "data": [
    {
      "id": "1",
      "name": "Acme Corporation",
      "domain": "acme-corp",
      "status": "active",
      "plan": "enterprise",
      "createdAt": "2025-08-20T10:30:15.123Z",
      "updatedAt": "2025-08-25T14:22:33.456Z",
      "settings": {
        "timezone": "America/Sao_Paulo",
        "currency": "BRL",
        "features": ["analytics", "funnels", "exports"]
      },
      "stats": {
        "workspaces": 5,
        "apiKeys": 12,
        "eventsLast30Days": 1250000,
        "storageUsedMB": 2340.5
      }
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalItems": 156,
    "totalPages": 8,
    "hasNextPage": true,
    "hasPreviousPage": false
  },
  "meta": {
    "search": "acme",
    "sortBy": "createdAt",
    "sortOrder": "desc",
    "includeStats": true
  }
}
```

### 2. üîç Get Tenant by ID
**GET** `/v1/tenants/:tenantId`

Recupera detalhes completos de um tenant espec√≠fico.

**Par√¢metros**:
- `tenantId`: ID do tenant

**Response**:
```json
{
  "id": "1",
  "name": "Acme Corporation",
  "domain": "acme-corp",
  "status": "active",
  "plan": "enterprise",
  "createdAt": "2025-08-20T10:30:15.123Z",
  "updatedAt": "2025-08-25T14:22:33.456Z",
  "settings": {
    "timezone": "America/Sao_Paulo",
    "currency": "BRL",
    "language": "pt-BR",
    "features": ["analytics", "funnels", "exports", "realtime"],
    "limits": {
      "maxWorkspaces": 10,
      "maxApiKeys": 50,
      "maxEventsPerMonth": 10000000,
      "dataRetentionDays": 365
    }
  },
  "billing": {
    "billingEmail": "billing@acme-corp.com",
    "paymentMethod": "credit_card",
    "nextBillingDate": "2025-09-20T00:00:00.000Z",
    "subscriptionStatus": "active"
  },
  "stats": {
    "workspaces": 5,
    "apiKeys": 12,
    "eventsLast30Days": 1250000,
    "eventsCurrentMonth": 2340000,
    "storageUsedMB": 2340.5,
    "lastActivityAt": "2025-08-27T14:30:15.123Z"
  },
  "workspaces": [
    {
      "id": "1",
      "name": "Production",
      "description": "Production environment",
      "status": "active",
      "createdAt": "2025-08-20T10:45:22.789Z"
    }
  ]
}
```

### 3. ‚ûï Create New Tenant
**POST** `/v1/tenants`

Cria um novo tenant no sistema.

**Request Body**:
```json
{
  "name": "New Company Ltd",
  "domain": "new-company",
  "contactEmail": "admin@newcompany.com",
  "plan": "professional",
  "settings": {
    "timezone": "America/Sao_Paulo",
    "currency": "BRL",
    "language": "pt-BR",
    "features": ["analytics", "funnels"]
  },
  "billing": {
    "billingEmail": "billing@newcompany.com",
    "paymentMethod": "credit_card"
  }
}
```

**Response** (201):
```json
{
  "id": "157",
  "name": "New Company Ltd", 
  "domain": "new-company",
  "status": "active",
  "plan": "professional",
  "createdAt": "2025-08-27T15:30:15.123Z",
  "updatedAt": "2025-08-27T15:30:15.123Z",
  "settings": {
    "timezone": "America/Sao_Paulo",
    "currency": "BRL",
    "language": "pt-BR",
    "features": ["analytics", "funnels"],
    "limits": {
      "maxWorkspaces": 5,
      "maxApiKeys": 25,
      "maxEventsPerMonth": 1000000,
      "dataRetentionDays": 90
    }
  },
  "defaultWorkspace": {
    "id": "245",
    "name": "Default",
    "description": "Default workspace"
  }
}
```

### 4. ‚úèÔ∏è Update Tenant
**PATCH** `/v1/tenants/:tenantId`

Atualiza informa√ß√µes de um tenant existente.

**Par√¢metros**:
- `tenantId`: ID do tenant

**Request Body** (campos opcionais):
```json
{
  "name": "Updated Company Name",
  "status": "suspended",
  "settings": {
    "features": ["analytics", "funnels", "exports"],
    "limits": {
      "maxEventsPerMonth": 5000000
    }
  },
  "billing": {
    "billingEmail": "new-billing@company.com"
  }
}
```

**Response** (200):
```json
{
  "id": "1",
  "name": "Updated Company Name",
  "status": "suspended",
  "updatedAt": "2025-08-27T15:45:22.456Z",
  "changes": [
    {
      "field": "name",
      "oldValue": "Old Company Name", 
      "newValue": "Updated Company Name"
    },
    {
      "field": "status",
      "oldValue": "active",
      "newValue": "suspended"
    }
  ]
}
```

### 5. üóëÔ∏è Delete Tenant
**DELETE** `/v1/tenants/:tenantId`

Soft delete de um tenant (arquivamento seguro).

**Par√¢metros**:
- `tenantId`: ID do tenant

**Response** (200):
```json
{
  "id": "1",
  "name": "Archived Company",
  "status": "deleted",
  "deletedAt": "2025-08-27T15:50:15.789Z",
  "dataRetentionUntil": "2025-11-27T15:50:15.789Z",
  "backupInfo": {
    "backupId": "backup_20250827_tenant_1",
    "expiresAt": "2025-11-27T15:50:15.789Z"
  }
}
```

---

## üîê Autentica√ß√£o e Permiss√µes

### M√©todos de Autentica√ß√£o Suportados

#### 1. API Key (Tenant-scoped)
```bash
curl -H "Authorization: Bearer tenant_api_key" \
     "http://localhost:3000/v1/tenants/1"
```
- **Escopo**: Apenas o tenant propriet√°rio da API key
- **Permiss√µes**: Baseadas no escopo da API key

#### 2. Supabase JWT (User-based)  
```bash
curl -H "Authorization: Bearer supabase_jwt_token" \
     "http://localhost:3000/v1/tenants"
```
- **Escopo**: Baseado nas permiss√µes do usu√°rio
- **Permiss√µes**: Admin, Manager, ou View-only

### N√≠veis de Permiss√£o

#### üî¥ Super Admin
- **Acesso**: Todos os tenants
- **Opera√ß√µes**: CREATE, READ, UPDATE, DELETE
- **Recursos especiais**: Billing, analytics agregadas

#### üü° Tenant Admin
- **Acesso**: Apenas seus tenants
- **Opera√ß√µes**: READ, UPDATE (limitado)
- **Recursos**: Configura√ß√µes, usu√°rios, workspaces

#### üü¢ API Key (tenant-scoped)
- **Acesso**: Apenas tenant propriet√°rio
- **Opera√ß√µes**: READ (pr√≥prio tenant)
- **Recursos**: Informa√ß√µes b√°sicas

---

## üîß Configura√ß√£o e Setup

### Pr√©-requisitos
- ‚úÖ PostgreSQL com schema multi-tenant
- ‚úÖ Supabase configurado (opcional)
- ‚úÖ Redis para cache (opcional)

### Vari√°veis de Ambiente
```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/mercurio

# Tenant Management
TENANT_DEFAULT_PLAN=starter              # Plano padr√£o
TENANT_MAX_PER_USER=5                   # Max tenants por usu√°rio
TENANT_DOMAIN_VALIDATION=true           # Validar dom√≠nios √∫nicos

# Features & Limits
FEATURE_ANALYTICS_ENABLED=true          # Analytics por padr√£o
FEATURE_FUNNELS_ENABLED=true           # Funnels por padr√£o
DEFAULT_DATA_RETENTION_DAYS=90          # Reten√ß√£o padr√£o

# Billing Integration
BILLING_PROVIDER=stripe                 # stripe | manual
STRIPE_WEBHOOK_SECRET=whsec_...        # Stripe webhook
```

---

## üí° Exemplos de Uso

### 1. Administra√ß√£o B√°sica
```bash
# Listar todos os tenants ativos
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants?status=active&includeStats=true"

# Buscar tenants por nome
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants?search=acme&pageSize=10"

# Obter detalhes completos de um tenant
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants/1"
```

### 2. Cria√ß√£o de Tenant
```bash
# Criar novo tenant enterprise
curl -X POST \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer admin_token" \
     -d '{
       "name": "Enterprise Corp",
       "domain": "enterprise-corp",
       "contactEmail": "admin@enterprise.com",
       "plan": "enterprise",
       "settings": {
         "timezone": "America/New_York",
         "features": ["analytics", "funnels", "exports", "realtime"]
       }
     }' \
     "http://localhost:3000/v1/tenants"
```

### 3. Gerenciamento de Status
```bash
# Suspender tenant
curl -X PATCH \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer admin_token" \
     -d '{"status": "suspended"}' \
     "http://localhost:3000/v1/tenants/1"

# Reativar tenant
curl -X PATCH \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer admin_token" \
     -d '{"status": "active"}' \
     "http://localhost:3000/v1/tenants/1"
```

### 4. Upgrade de Plano
```bash
# Upgrade para enterprise
curl -X PATCH \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer admin_token" \
     -d '{
       "plan": "enterprise",
       "settings": {
         "features": ["analytics", "funnels", "exports", "realtime", "api_access"],
         "limits": {
           "maxEventsPerMonth": 10000000,
           "dataRetentionDays": 365
         }
       }
     }' \
     "http://localhost:3000/v1/tenants/1"
```

---

## üìä Tenant Analytics

### M√©tricas Dispon√≠veis
- **Eventos**: Total de eventos dos √∫ltimos 30 dias
- **Storage**: Uso de armazenamento em MB
- **Workspaces**: N√∫mero de workspaces ativos
- **API Keys**: N√∫mero de chaves ativas
- **√öltima Atividade**: Timestamp da √∫ltima atividade

### Dashboard de Admin
```bash
# Obter estat√≠sticas agregadas
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants?includeStats=true&pageSize=100" | \
     jq '.data | map({name, plan, eventsLast30Days: .stats.eventsLast30Days}) | sort_by(.eventsLast30Days) | reverse'
```

---

## üõ†Ô∏è Troubleshooting

### Problemas Comuns

#### 1. Tenant Not Found (404)
**Causa**: Tenant n√£o existe ou usu√°rio sem permiss√£o
**Solu√ß√£o**:
```bash
# Verificar se tenant existe
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants" | jq '.data[] | select(.id == "1")'
```

#### 2. Domain Already Exists (409)  
**Causa**: Domain j√° est√° em uso por outro tenant
**Solu√ß√£o**:
```bash
# Listar tenants com dom√≠nio similar
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants?search=domain-name"
```

#### 3. Insufficient Permissions (403)
**Causa**: API key ou usu√°rio sem permiss√µes adequadas
**Diagn√≥stico**:
```bash
# Verificar permiss√µes da API key
curl -H "Authorization: Bearer api_key" \
     "http://localhost:3000/v1/auth/me"
```

#### 4. Plan Limits Exceeded
**Causa**: Tenant excedeu limites do plano atual
**Solu√ß√£o**: Upgrade de plano ou redu√ß√£o de uso
```bash
# Verificar limites atuais
curl -H "Authorization: Bearer admin_token" \
     "http://localhost:3000/v1/tenants/1" | jq '.settings.limits'
```

---

## üìö Recursos Adicionais

### Links √öteis
- **Workspace Management**: [Workspace API docs](/docs/features/workspaces/README.md)
- **Authentication Guide**: [Auth docs](/docs/features/authentication/hybrid-auth-guide.md)
- **Multi-tenant Architecture**: [Architecture docs](/docs/architecture/tenancy.md)

### Scripts de Administra√ß√£o
```bash
# Bulk tenant status update
./scripts/bulk-tenant-operation.sh suspend inactive-tenants.txt

# Tenant usage report  
./scripts/generate-tenant-report.sh --period 30d --format csv

# Tenant cleanup (soft delete old inactive tenants)
./scripts/cleanup-inactive-tenants.sh --days 90
```

### Integra√ß√£o com Billing
```javascript
// Webhook handler para Stripe
app.post('/webhooks/stripe', (req, res) => {
  const event = req.body;
  
  switch (event.type) {
    case 'customer.subscription.updated':
      updateTenantPlan(event.data.object.customer, event.data.object.plan);
      break;
    case 'customer.subscription.deleted':
      suspendTenant(event.data.object.customer);
      break;
  }
  
  res.json({ received: true });
});
```

---

**üè¢ Tenant Management API - Vers√£o 1.0.0**  
*Implementado com ‚ù§Ô∏è pelo time Mercurio*